<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta http-equiv="Content-Security-Policy" content="default-src * 'self' data: gap: 'unsafe-inline' 'unsafe-eval'; style-src * 'self' 'unsafe-inline'; media-src *; img-src * 'self' data:; connect-src * 'self';" />
  <title>Cart - Book Store</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/mobile-responsive.css">
  <style>
    :root {
      --bg-0: #0a0a0a;
      --bg-1: #1a1a2e;
      --bg-2: #16213e;
      --accent-a: #ff6b6b;
      --accent-b: #4ecdc4;
      --accent-c: #45b7d1;
      --glow-1: rgba(255,107,107,0.15);
      --glow-2: rgba(78,205,196,0.10);
      --glow-3: rgba(69,183,209,0.08);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: var(--bg-0); color: #ffffff; overflow-x: hidden; position: relative; }
    .bg-gradient { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; background: linear-gradient(135deg, var(--bg-0) 0%, var(--bg-1) 50%, var(--bg-2) 100%); overflow: hidden; }
    .cursor-glow { position: absolute; width: 800px; height: 800px; border-radius: 50%; background: radial-gradient(circle, var(--glow-1) 0%, var(--glow-2) 25%, var(--glow-3) 50%, transparent 70%); pointer-events: none; transition: all 0.3s cubic-bezier(0.23, 1, 0.320, 1); transform: translate(-50%, -50%); filter: blur(2px); }
    .cursor-trail { position: absolute; width: 400px; height: 400px; border-radius: 50%; background: radial-gradient(circle, rgba(255,107,107,0.08) 0%, rgba(150,206,180,0.06) 40%, transparent 70%); pointer-events: none; transition: all 0.8s cubic-bezier(0.23, 1, 0.320, 1); transform: translate(-50%, -50%); filter: blur(4px); }
    .cursor-trail-2 { position: absolute; width: 200px; height: 200px; border-radius: 50%; background: radial-gradient(circle, var(--glow-2) 0%, var(--glow-1) 50%, transparent 70%); pointer-events: none; transition: all 1.2s cubic-bezier(0.23, 1, 0.320, 1); transform: translate(-50%, -50%); filter: blur(1px); }
    .bg-gradient::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at 20% 20%, rgba(120, 119, 198, 0.06) 0%, transparent 30%), radial-gradient(circle at 80% 80%, rgba(255, 119, 198, 0.05) 0%, transparent 30%), radial-gradient(circle at 50% 10%, rgba(120, 219, 255, 0.04) 0%, transparent 40%); animation: ambientGlow 10s ease-in-out infinite; }
    @keyframes ambientGlow { 0%, 100% { opacity: 0.45; } 50% { opacity: 0.8; } }
    .navbar { position: fixed; top: 0; width: 100%; z-index: 1000; backdrop-filter: blur(20px); background: rgba(0, 0, 0, 0.2); border-bottom: 1px solid rgba(255, 255, 255, 0.06); animation: slideDown 0.8s ease-out; }
    @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .nav-container { max-width: 1200px; margin: 0 auto; padding: 1rem 2rem; display: flex; justify-content: center; align-items: center; gap: 2rem; }
    .nav-brand { opacity: 0; animation: fadeInUp 0.8s ease-out 0.2s forwards; text-align: center; }
    .brand-logo { font-size: 1.8rem; font-weight: 700; background: linear-gradient(45deg, var(--accent-a), var(--accent-b)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; animation: shimmer 3s ease-in-out infinite; }
    @keyframes shimmer { 0%, 100% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } }
    .brand-tagline { font-size: 0.9rem; color: rgba(255, 255, 255, 0.7); font-weight: 300; }
    .nav-links { display: flex; gap: 1rem; }
    .nav-group { display: flex; gap: 1rem; align-items: center; }
    .nav-link { color: rgba(255, 255, 255, 0.8); text-decoration: none; padding: 0.7rem 1.5rem; border-radius: 50px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden; border: none; background: none; cursor: pointer; font-family: inherit; opacity: 0; animation: fadeInUp 0.8s ease-out 0.4s forwards; }
    .nav-link::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.06), transparent); transition: left 0.5s ease; }
    .nav-link:hover::before { left: 100%; }
    .nav-link:hover { transform: translateY(-2px); color: #ffffff; text-shadow: 0 0 20px rgba(255, 255, 255, 0.5); }
    .btn-primary { background: linear-gradient(45deg, var(--accent-a), var(--accent-b)); color: white !important; box-shadow: 0 4px 20px rgba(255, 107, 107, 0.18); }
    .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 8px 30px rgba(255, 107, 107, 0.28); }
    .btn-secondary { background: rgba(255, 255, 255, 0.06); color: white !important; border: 1px solid rgba(255, 255, 255, 0.08); }
    .main-content { min-height: 100vh; padding: 100px 1rem 2rem; position: relative; max-width: 1200px; margin: 0 auto; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    .page-title { font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem; text-align: center; background: linear-gradient(45deg, var(--accent-a), var(--accent-b)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .page-subtitle { font-size: 1.1rem; color: rgba(255,255,255,0.7); text-align:center; margin-bottom: 2rem; }
    .cart-container { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.04); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; }
    .cart-item { display: flex; gap: 1.5rem; padding: 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.05); align-items: center; }
    .cart-item:last-child { border-bottom: none; }
    .cart-item-checkbox { width: 24px; height: 24px; cursor: pointer; accent-color: var(--accent-b); flex-shrink: 0; }
    .cart-item-image { width: 80px; height: 80px; border-radius: 8px; object-fit: cover; border: 1px solid rgba(255,255,255,0.06); }
    .select-all-container { display: flex; align-items: center; gap: 0.75rem; padding: 1rem 1.5rem; background: rgba(255,255,255,0.02); border-bottom: 1px solid rgba(255,255,255,0.05); margin-bottom: 1rem; }
    .select-all-checkbox { width: 20px; height: 20px; cursor: pointer; accent-color: var(--accent-b); }
    .select-all-label { font-weight: 600; color: rgba(255,255,255,0.9); cursor: pointer; }
    .cart-item-details { flex: 1; }
    .cart-item-name { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem; color: #fff; }
    .cart-item-price { color: rgba(255,255,255,0.7); font-size: 0.95rem; }
    .cart-item-quantity { display: flex; align-items: center; gap: 1rem; margin-top: 0.5rem; }
    .quantity-input { width: 60px; padding: 0.5rem; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 8px; color: #fff; text-align: center; }
    .quantity-btn { padding: 0.4rem 0.8rem; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; color: #fff; cursor: pointer; }
    .quantity-btn:hover { background: rgba(255,255,255,0.1); }
    .cart-item-subtotal { font-size: 1.2rem; font-weight: 600; color: var(--accent-b); min-width: 100px; text-align: right; }
    .remove-btn { padding: 0.5rem 1rem; background: linear-gradient(90deg, rgba(227,52,47,0.95), rgba(235,80,70,0.95)); border: none; border-radius: 8px; color: #fff; cursor: pointer; font-weight: 600; }
    .remove-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(227,52,47,0.3); }
    .cart-summary { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.04); border-radius: 12px; padding: 1.5rem; margin-top: 2rem; }
    .summary-row { display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .summary-row:last-child { border-bottom: none; font-size: 1.3rem; font-weight: 700; color: var(--accent-b); }
    .checkout-btn { width: 100%; padding: 1rem 2rem; background: linear-gradient(45deg, var(--accent-a), var(--accent-b)); border: none; border-radius: 12px; color: #fff; font-size: 1.1rem; font-weight: 600; cursor: pointer; margin-top: 1.5rem; }
    .checkout-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(255, 107, 107, 0.3); }
    .checkout-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .checkout-box { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.04); border-radius: 12px; padding: 2rem; margin-top: 2rem; display: none; }
    .checkout-box.show { display: block; animation: fadeInUp 0.5s ease-out; }
    .checkout-title { font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem; color: var(--accent-b); }
    .checkout-form { display: grid; gap: 1.5rem; }
    .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
    .form-label { font-weight: 500; color: rgba(255,255,255,0.9); font-size: 0.95rem; }
    .form-input, .form-textarea, .form-select { padding: 0.75rem; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 8px; color: #fff; font-size: 1rem; font-family: inherit; transition: all 0.3s ease; }
    .form-textarea { min-height: 100px; resize: vertical; }
    .form-input:focus, .form-textarea:focus, .form-select:focus { outline: none; border-color: var(--accent-b); background: rgba(255,255,255,0.05); box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.1); }
    .form-input::placeholder, .form-textarea::placeholder { color: rgba(255,255,255,0.4); }
    .payment-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 0.5rem; }
    .payment-option { padding: 1rem; background: rgba(255,255,255,0.03); border: 2px solid rgba(255,255,255,0.06); border-radius: 8px; cursor: pointer; transition: all 0.3s ease; text-align: center; }
    .payment-option:hover { background: rgba(255,255,255,0.05); border-color: var(--accent-b); }
    .payment-option input[type="radio"] { display: none; }
    .payment-option input[type="radio"]:checked + label { color: var(--accent-b); }
    .payment-option:has(input[type="radio"]:checked) { border-color: var(--accent-b); background: rgba(78, 205, 196, 0.1); }
    .payment-option label { cursor: pointer; font-weight: 500; display: block; }
    .place-order-btn { width: 100%; padding: 1rem 2rem; background: linear-gradient(45deg, var(--accent-a), var(--accent-b)); border: none; border-radius: 12px; color: #fff; font-size: 1.1rem; font-weight: 600; cursor: pointer; margin-top: 1rem; }
    .place-order-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(255, 107, 107, 0.3); }
    .place-order-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .empty-cart { text-align: center; padding: 4rem 2rem; color: rgba(255,255,255,0.6); }
    .empty-cart-icon { font-size: 4rem; margin-bottom: 1rem; }
    .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-0); z-index: 9999; display:flex; justify-content:center; align-items:center; }
    .loading-indicator { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 3rem; min-height: 200px; }
    .loader { width:50px; height:50px; border:3px solid rgba(255,255,255,0.08); border-top:3px solid var(--accent-a); border-radius:50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hamburger { display: none; background: none; border: none; cursor: pointer; padding: 0.5rem; z-index: 1001; }
    .hamburger span { display: block; width: 25px; height: 2px; background: #fff; margin: 5px 0; transition: 0.3s; }
    .cart-badge { position: relative; }
    .cart-badge-count { position: absolute; top: -8px; right: -8px; background: var(--accent-a); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; }
    
    @media (max-width:768px) {
      .cart-item { flex-direction: column; text-align: center; }
      .cart-item-image { width: 120px; height: 120px; }
      .cart-item-quantity { justify-content: center; }
      .cart-item-subtotal { text-align: center; margin-top: 1rem; }
      .checkout-box { padding: 1.5rem; }
      .checkout-title { font-size: 1.3rem; }
      .payment-options { grid-template-columns: 1fr; }
      .hamburger { display: block; position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); }
      .hamburger.active span:nth-child(1) { transform: rotate(45deg) translate(6px, 6px); }
      .hamburger.active span:nth-child(2) { opacity: 0; }
      .hamburger.active span:nth-child(3) { transform: rotate(-45deg) translate(6px, -6px); }
      .nav-links { position: fixed; top: 0; right: -100%; width: 70%; max-width: 280px; height: 100vh; background: rgba(10, 10, 10, 0.98); backdrop-filter: blur(20px); flex-direction: column; padding: 5rem 2rem 2rem; gap: 0.5rem; transition: right 0.3s ease; border-left: 1px solid rgba(255,255,255,0.1); z-index: 999; }
      .nav-links.active { right: 0; }
      .nav-link { width: 100%; text-align: left; padding: 1rem; border-radius: 8px; }
      
      /* Ensure auth-only elements are visible in mobile menu when logged in */
      .nav-links.active .auth-only {
        display: block !important;
      }
      .nav-links.active .guest-only {
        display: none !important;
      }
      
      /* Overlay for mobile menu */
      .nav-overlay { 
        display: none;
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        background: rgba(0,0,0,0.7); 
        z-index: 998; 
      }
      .nav-overlay.active { display: block; }
    }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loadingOverlay" style="display:none;">
    <div class="loader"></div>
  </div>

  <div class="bg-gradient"></div>
  <div class="cursor-glow" id="cursorGlow"></div>
  <div class="cursor-trail" id="cursorTrail"></div>
  <div class="cursor-trail-2" id="cursorTrail2"></div>

  <nav class="navbar">
    <div class="nav-container">
      <div class="nav-brand">
        <a href="index.html" class="brand-logo">Book Store</a>
        <div class="brand-tagline">E-Commerce Platform</div>
      </div>
      <button class="hamburger" id="hamburger" aria-label="Toggle menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <div class="nav-links" id="navLinks">
        <div class="nav-group">
          <a href="index.html" class="nav-link hide-for-admin">Home</a>
          <a href="books.html" class="nav-link">Books</a>
          <a href="cart.html" class="nav-link cart-badge user-only active">
            Cart
            <span class="cart-badge-count" id="cartBadge" style="display:none;">0</span>
          </a>
          <a href="orders.html" class="nav-link">Orders</a>
          <a href="users.html" class="nav-link admin-only" style="display:none;">Users</a>
          <a href="profile.html" class="nav-link auth-only">Profile</a>
          <button class="nav-link auth-only btn-secondary" id="logoutBtn">Logout</button>
          <a href="login.html" class="nav-link guest-only">Login</a>
        </div>
      </div>
    </div>
  </nav>
  <div class="nav-overlay" id="navOverlay"></div>

  <div class="main-content">
    <h1 class="page-title">Shopping Cart</h1>
    <p class="page-subtitle">Review your items before checkout</p>

    <div id="loadingIndicator" class="loading-indicator" style="display: none;">
      <div class="loader"></div>
      <p style="margin-top: 1rem; color: rgba(255,255,255,0.7);">Loading cart...</p>
    </div>
    
    <div id="selectAllContainer" style="display:none;">
      <div class="select-all-container">
        <input type="checkbox" id="selectAllCheckbox" class="select-all-checkbox" checked>
        <label for="selectAllCheckbox" class="select-all-label">Select All</label>
      </div>
    </div>

    <div id="cartContainer" style="display: none;"></div>

    <div id="cartSummary" style="display:none;">
      <div class="cart-summary">
        <div class="summary-row">
          <span>Subtotal</span>
          <span id="subtotal">‚Ç±0.00</span>
        </div>
        <div class="summary-row">
          <span>Total</span>
          <span id="total">‚Ç±0.00</span>
        </div>
        <button class="checkout-btn" id="checkoutBtn">Proceed to Checkout</button>
      </div>
    </div>

    <div id="checkoutBox" class="checkout-box">
      <h2 class="checkout-title">Checkout</h2>
      <form id="checkoutForm" class="checkout-form">
        <div class="form-group">
          <label class="form-label" for="shippingAddress">Shipping Address *</label>
          <textarea id="shippingAddress" name="shipping_address" class="form-textarea" placeholder="Enter your complete shipping address" required></textarea>
        </div>
        
        <div class="form-group">
          <label class="form-label" for="contactNumber">Contact Number *</label>
          <input type="text" id="contactNumber" name="contact_number" class="form-input" placeholder="e.g. 09123456789" inputmode="numeric" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">Payment Method</label>
          <div class="payment-info" style="margin-top: 0.5rem;">
            <div class="payment-info-title">üí≥ Cash on Delivery</div>
            <div class="payment-info-text">Pay when you receive your order</div>
          </div>
          <input type="hidden" name="paymentMethod" value="cash_on_delivery">
        </div>

        <div class="cart-summary" style="margin-top: 1rem;">
          <div class="summary-row">
            <span>Subtotal</span>
            <span id="checkoutSubtotal">‚Ç±0.00</span>
          </div>
          <div class="summary-row">
            <span>Total</span>
            <span id="checkoutTotal">‚Ç±0.00</span>
          </div>
        </div>

        <button type="submit" class="place-order-btn" id="placeOrderBtn">Place Order</button>
      </form>
    </div>
  </div>

  <script src="config.js"></script>
  <script src="error-handler.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="app.js"></script>
  <script>
    // Mobile menu toggle
    (function() {
      const hamburger = document.getElementById('hamburger');
      const navLinks = document.getElementById('navLinks');
      const navOverlay = document.getElementById('navOverlay');
      
      if (!hamburger || !navLinks || !navOverlay) return;
      
      function toggleMenu() {
        hamburger.classList.toggle('active');
        navLinks.classList.toggle('active');
        navOverlay.classList.toggle('active');
        document.body.style.overflow = navLinks.classList.contains('active') ? 'hidden' : '';
        
        // Ensure auth-only elements are visible when menu opens
        if (navLinks.classList.contains('active') && typeof isAuthed === 'function' && isAuthed()) {
          navLinks.querySelectorAll('.auth-only').forEach(el => {
            el.style.display = '';
          });
          navLinks.querySelectorAll('.guest-only').forEach(el => {
            el.style.display = 'none';
          });
        }
      }
      
      hamburger.addEventListener('click', toggleMenu);
      navOverlay.addEventListener('click', toggleMenu);
      
      // Close menu when clicking on a link
      navLinks.querySelectorAll('.nav-link, a').forEach(link => {
        link.addEventListener('click', () => {
          if (navLinks.classList.contains('active')) {
            toggleMenu();
          }
        });
      });
    })();

    // Initialize navigation immediately on page load
    function initializeNavigation() {
      if (typeof setAuthUI === 'function' && typeof isAuthed === 'function') {
        const isLoggedIn = isAuthed();
        setAuthUI(isLoggedIn);
        
        // Ensure auth-only elements are visible if logged in
        if (isLoggedIn) {
          document.querySelectorAll('.auth-only').forEach(el => {
            el.style.display = '';
          });
          document.querySelectorAll('.guest-only').forEach(el => {
            el.style.display = 'none';
          });
        }
      }
    }
    
    // Run immediately and also on DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeNavigation);
    } else {
      initializeNavigation();
    }
    
    // Make brand logo non-clickable when logged in
    function updateBrandLogo() {
      const brandLogo = document.querySelector('.brand-logo');
      if (brandLogo && typeof isAuthed === 'function') {
        if (isAuthed()) {
          // User is logged in - make it non-clickable
          if (brandLogo.tagName === 'A') {
            const text = brandLogo.textContent;
            const parent = brandLogo.parentNode;
            const span = document.createElement('span');
            span.className = brandLogo.className;
            span.textContent = text;
            span.style.cursor = 'default';
            span.style.textDecoration = 'none';
            parent.replaceChild(span, brandLogo);
          }
        } else {
          // User is not logged in - make it clickable
          if (brandLogo.tagName !== 'A') {
            const text = brandLogo.textContent;
            const parent = brandLogo.parentNode;
            const link = document.createElement('a');
            link.className = brandLogo.className;
            link.href = 'index.html';
            link.textContent = text;
            parent.replaceChild(link, brandLogo);
          }
        }
      }
    }
    
    // Update brand logo on page load
    if (typeof isAuthed === 'function') {
      updateBrandLogo();
    }

    // Check if user is seller/admin and redirect them
    async function checkUserRoleAndRedirect() {
      try {
        if (typeof isAuthed === 'function' && isAuthed()) {
          const user = await api('/users/me');
          if (user && (user.role === 'seller' || user.role === 'admin')) {
            // Sellers and admins should not access cart - redirect to orders
            if (window.Swal && typeof Swal.fire === 'function') {
              Swal.fire({ 
                icon: 'warning', 
                title: 'Access Denied', 
                text: user.role === 'seller' 
                  ? 'Sellers can only approve/decline orders. Redirecting to orders page...' 
                  : 'Admins can only view orders. Redirecting to orders page...',
                timer: 2000,
                showConfirmButton: false
              }).then(() => {
                location.href = 'orders.html';
              });
            } else {
              alert(user.role === 'seller' 
                ? 'Sellers can only approve/decline orders. Redirecting...' 
                : 'Admins can only view orders. Redirecting...');
              location.href = 'orders.html';
            }
            return false; // Stop execution
          }
        }
        return true; // Continue execution
      } catch (err) {
        console.error('Error checking user role:', err);
        return true; // Continue execution on error
      }
    }

    // Check user role on page load
    checkUserRoleAndRedirect();

    // Cart functionality
    let cartItems = [];

    async function loadCart() {
      const loadingIndicator = document.getElementById('loadingIndicator');
      const cartContainer = document.getElementById('cartContainer');
      const selectAllContainer = document.getElementById('selectAllContainer');
      
      // Show loading indicator BEFORE starting fetch
      if (loadingIndicator) loadingIndicator.style.display = 'flex';
      if (cartContainer) cartContainer.style.display = 'none';
      if (selectAllContainer) selectAllContainer.style.display = 'none';
      
      try {
        console.log('Loading cart...');
        const response = await api('/cart');
        console.log('Cart response:', response);
        console.log('Response type:', typeof response);
        console.log('Is array?', Array.isArray(response));
        
        // Handle different response structures
        if (Array.isArray(response)) {
          cartItems = response;
        } else if (response && response.items) {
          cartItems = response.items;
        } else if (response && Array.isArray(response.data)) {
          cartItems = response.data;
        } else {
          cartItems = [];
        }
        
        console.log('Cart items after parsing:', cartItems);
        console.log('Cart items length:', cartItems.length);
        
        if (!cartItems || cartItems.length === 0) {
          document.getElementById('cartContainer').innerHTML = `
            <div class="empty-cart">
              <div class="empty-cart-icon">üõí</div>
              <p>Your cart is empty</p>
              <a href="books.html" class="nav-link btn-primary" style="display:inline-block; margin-top:1rem;">Browse Books</a>
            </div>
          `;
          document.getElementById('cartSummary').style.display = 'none';
          return;
        }

        renderCart();
        const total = response.total || (response && response.total_amount) || '0.00';
        updateSummary(total);
        document.getElementById('cartSummary').style.display = 'block';
        // Show select all container when there are items
        if (cartItems.length > 0) {
          document.getElementById('selectAllContainer').style.display = 'block';
        } else {
          document.getElementById('selectAllContainer').style.display = 'none';
        }
      } catch (err) {
        console.error('Failed to load cart:', err);
        const errorMessage = err && err.message ? err.message : JSON.stringify(err, null, 2);
        console.error('Error details:', err);
        
        const status = err.status || (err.response && err.response.status);
        const responseText = err.responseText || (err.response && err.response.responseText) || '';
        const message = errorMessage || responseText;
        
        console.log('Cart error - status:', status, 'message:', message);
        
        if (message.includes('Unauthorized') || message.includes('401')) {
          location.href = 'login.html';
        } else if (status === 403 || message.includes('Forbidden') || message.includes('403') || message.includes('only available for regular users')) {
          // User is seller/admin - redirect to orders
          console.log('Detected seller/admin - redirecting to orders...');
          if (window.Swal && typeof Swal.fire === 'function') {
            Swal.fire({ 
              icon: 'warning', 
              title: 'Access Denied', 
              text: 'Sellers and admins cannot access cart. Redirecting to orders page...',
              timer: 2000,
              showConfirmButton: false
            }).then(() => {
              location.href = 'orders.html';
            });
          } else {
            alert('Sellers and admins cannot access cart. Redirecting...');
            location.href = 'orders.html';
          }
          return;
        } else {
          document.getElementById('cartContainer').innerHTML = `
            <div class="empty-cart">
              <div class="empty-cart-icon">‚ö†Ô∏è</div>
              <p>Failed to load cart</p>
              <p style="margin-top:0.5rem; color:rgba(255,255,255,0.7); font-size:0.9rem;">${errorMessage}</p>
            </div>
          `;
        }
      } finally {
        // Hide loading indicator and show cart
        if (loadingIndicator) loadingIndicator.style.display = 'none';
        if (cartContainer) cartContainer.style.display = 'block';
      }
    }

    function renderCart() {
      const container = document.getElementById('cartContainer');
      const selectAllContainer = document.getElementById('selectAllContainer');
      const uploadsUrl = window.CONFIG ? window.CONFIG.UPLOADS_URL : 'http://localhost:8000/uploads/';
      
      console.log('Rendering cart with items:', cartItems);
      
      if (!cartItems || cartItems.length === 0) {
        container.innerHTML = `
          <div class="empty-cart">
            <div class="empty-cart-icon">üõí</div>
            <p>Your cart is empty</p>
            <a href="books.html" class="nav-link btn-primary" style="display:inline-block; margin-top:1rem;">Browse Books</a>
          </div>
        `;
        if (selectAllContainer) selectAllContainer.style.display = 'none';
        return;
      }
      
      if (selectAllContainer) selectAllContainer.style.display = 'block';
      
      container.innerHTML = cartItems.map(item => {
        console.log('Rendering item:', item);
        const book = item.book || item.book_id || {};
        const imagePath = (book.image_path || book.imagePath || 'default.png').replace(/^uploads\//, '');
        const imageUrl = uploadsUrl + imagePath;
        // Ensure price is a number
        const bookPrice = parseFloat(book.price || 0) || 0;
        const subtotal = (item.quantity * bookPrice).toFixed(2);
        
        return `
          <div class="cart-item" data-id="${item.id}">
            <input type="checkbox" class="cart-item-checkbox" data-cart-id="${item.id}" checked onchange="updateSelectedItems()">
            <img src="${imageUrl}" alt="${book.name}" class="cart-item-image" onerror="this.src='${uploadsUrl}default.png'">
            <div class="cart-item-details">
              <div class="cart-item-name">${book.name || 'Unknown Book'}</div>
              <div class="cart-item-price">‚Ç±${bookPrice.toFixed(2)} each</div>
              <div class="cart-item-quantity">
                <button class="quantity-btn" onclick="updateQuantity(${item.id}, ${item.quantity - 1})">-</button>
                <input type="number" class="quantity-input" value="${item.quantity}" min="1" 
                       inputmode="numeric"
                       onchange="updateQuantity(${item.id}, parseInt(this.value))">
                <button class="quantity-btn" onclick="updateQuantity(${item.id}, ${item.quantity + 1})">+</button>
                <button class="remove-btn" onclick="removeItem(${item.id})">Remove</button>
              </div>
            </div>
            <div class="cart-item-subtotal">‚Ç±${subtotal}</div>
          </div>
        `;
      }).join('');
      
      // Setup select all functionality
      setupSelectAll();
      updateSelectedItems();
      
      // Add numeric-only validation to quantity inputs
      setupNumericInputs();
    }
    
    // Function to setup numeric-only validation for inputs
    function setupNumericInputs() {
      const quantityInputs = document.querySelectorAll('.quantity-input');
      quantityInputs.forEach(input => {
        // Prevent empty field on backspace/delete - use beforeinput for better control
        input.addEventListener('beforeinput', function(e) {
          if (e.inputType === 'deleteContentBackward' || e.inputType === 'deleteContentForward') {
            const currentValue = this.value;
            const selectionStart = this.selectionStart || 0;
            const selectionEnd = this.selectionEnd || 0;
            const selectedText = currentValue.substring(selectionStart, selectionEnd);
            
            // Calculate what the value would be after deletion
            let newValue = '';
            if (selectionStart === selectionEnd) {
              // No selection - cursor position
              if (e.inputType === 'deleteContentBackward' && selectionStart > 0) {
                // Backspace: remove character before cursor
                newValue = currentValue.substring(0, selectionStart - 1) + currentValue.substring(selectionStart);
              } else if (e.inputType === 'deleteContentForward' && selectionStart < currentValue.length) {
                // Delete: remove character after cursor
                newValue = currentValue.substring(0, selectionStart) + currentValue.substring(selectionStart + 1);
              } else {
                newValue = currentValue;
              }
            } else {
              // Text is selected - remove selected text
              newValue = currentValue.substring(0, selectionStart) + currentValue.substring(selectionEnd);
            }
            
            // If result would be empty, prevent and set to 1
            if (newValue.trim() === '' || newValue.length === 0) {
              e.preventDefault();
              this.value = '1';
              // Set cursor position after setting value
              setTimeout(() => {
                this.setSelectionRange(1, 1);
              }, 0);
              return;
            }
          }
        });
        
        // Also handle keydown as fallback
        input.addEventListener('keydown', function(e) {
          if (e.keyCode === 8 || e.keyCode === 46) {
            const currentValue = this.value;
            const selectionStart = this.selectionStart || 0;
            const selectionEnd = this.selectionEnd || 0;
            
            // If all text is selected, prevent deletion
            if (selectionStart === 0 && selectionEnd === currentValue.length && currentValue.length > 0) {
              e.preventDefault();
              this.value = '1';
              setTimeout(() => {
                this.setSelectionRange(1, 1);
              }, 0);
              return;
            }
            
            // If only one character and cursor is at start (backspace) or end (delete)
            if (currentValue.length === 1) {
              e.preventDefault();
              this.value = '1';
              setTimeout(() => {
                this.setSelectionRange(1, 1);
              }, 0);
              return;
            }
          }
        });
        
        // Prevent non-numeric input
        input.addEventListener('keypress', function(e) {
          // Allow: backspace, delete, tab, escape, enter, decimal point, and numbers
          if ([46, 8, 9, 27, 13, 110, 190].indexOf(e.keyCode) !== -1 ||
              // Allow: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
              (e.keyCode === 65 && e.ctrlKey === true) ||
              (e.keyCode === 67 && e.ctrlKey === true) ||
              (e.keyCode === 86 && e.ctrlKey === true) ||
              (e.keyCode === 88 && e.ctrlKey === true) ||
              // Allow: home, end, left, right
              (e.keyCode >= 35 && e.keyCode <= 39)) {
            return;
          }
          // Ensure that it is a number and stop the keypress
          if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
            e.preventDefault();
            // Show warning
            if (window.Swal && typeof Swal.fire === 'function') {
              Swal.fire({ 
                icon: 'warning', 
                title: 'Numbers Only', 
                text: 'Please enter only numbers for quantity.',
                timer: 2000,
                showConfirmButton: false
              });
            } else {
              alert('Please enter only numbers for quantity.');
            }
          }
        });
        
        // Validate on input (for paste events)
        input.addEventListener('input', function(e) {
          const value = this.value;
          // Remove any non-numeric characters
          const numericValue = value.replace(/[^0-9]/g, '');
          if (value !== numericValue) {
            this.value = numericValue;
            // Show warning
            if (window.Swal && typeof Swal.fire === 'function') {
              Swal.fire({ 
                icon: 'warning', 
                title: 'Numbers Only', 
                text: 'Only numbers are allowed. Letters have been removed.',
                timer: 2000,
                showConfirmButton: false
              });
            } else {
              alert('Only numbers are allowed. Letters have been removed.');
            }
          }
          // Prevent empty field - if empty or becomes empty, set to 1
          if (this.value === '' || this.value.length === 0 || this.value.trim() === '') {
            this.value = '1';
            this.setSelectionRange(1, 1);
          }
          // Ensure minimum value of 1
          const numValue = parseInt(this.value) || 1;
          if (numValue < 1) {
            this.value = '1';
          }
        });
      });
    }
    
    function setupSelectAll() {
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');
      if (!selectAllCheckbox) return;
      
      selectAllCheckbox.addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.cart-item-checkbox');
        checkboxes.forEach(cb => cb.checked = this.checked);
        updateSelectedItems();
      });
    }
    
    function updateSelectedItems() {
      const checkboxes = document.querySelectorAll('.cart-item-checkbox');
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');
      const selectedItems = Array.from(checkboxes).filter(cb => cb.checked).map(cb => parseInt(cb.dataset.cartId));
      
      // Update select all checkbox state
      if (selectAllCheckbox) {
        selectAllCheckbox.checked = selectedItems.length === checkboxes.length && checkboxes.length > 0;
      }
      
      // Update summary with selected items only
      updateSummaryForSelected(selectedItems);
    }
    
    function updateSummaryForSelected(selectedItemIds) {
      if (selectedItemIds.length === 0) {
        document.getElementById('subtotal').textContent = '‚Ç±0.00';
        document.getElementById('total').textContent = '‚Ç±0.00';
        const checkoutBox = document.getElementById('checkoutBox');
        if (checkoutBox && checkoutBox.classList.contains('show')) {
          document.getElementById('checkoutSubtotal').textContent = '‚Ç±0.00';
          document.getElementById('checkoutTotal').textContent = '‚Ç±0.00';
        }
        return;
      }
      
      const selectedItems = cartItems.filter(item => selectedItemIds.includes(item.id));
      const total = selectedItems.reduce((sum, item) => {
        const book = item.book || item.book_id || {};
        const bookPrice = parseFloat(book.price || 0) || 0;
        return sum + (item.quantity * bookPrice);
      }, 0);
      
      const totalFormatted = total.toFixed(2);
      document.getElementById('subtotal').textContent = `‚Ç±${totalFormatted}`;
      document.getElementById('total').textContent = `‚Ç±${totalFormatted}`;
      // Also update checkout totals if checkout box is visible
      const checkoutBox = document.getElementById('checkoutBox');
      if (checkoutBox && checkoutBox.classList.contains('show')) {
        document.getElementById('checkoutSubtotal').textContent = `‚Ç±${totalFormatted}`;
        document.getElementById('checkoutTotal').textContent = `‚Ç±${totalFormatted}`;
      }
    }

    async function updateQuantity(cartId, newQuantity) {
      if (newQuantity < 1) {
        if (window.Swal && typeof Swal.fire === 'function') {
          Swal.fire({ icon: 'warning', title: 'Invalid Quantity', text: 'Quantity must be at least 1' });
        }
        return;
      }

      try {
        await api(`/cart/${cartId}`, { method: 'PUT', data: { quantity: newQuantity } });
        await loadCart();
        // Update selected items summary after cart reload
        setTimeout(() => {
          if (typeof updateSelectedItems === 'function') updateSelectedItems();
        }, 100);
        if (typeof updateCartBadge === 'function') updateCartBadge();
      } catch (err) {
        const message = (err && err.message) ? err.message : JSON.stringify(err, null, 2);
        if (window.Swal && typeof Swal.fire === 'function') {
          Swal.fire({ icon: 'error', title: 'Update Failed', text: message });
        } else {
          alert('Failed to update: ' + message);
        }
      }
    }

    async function removeItem(cartId) {
      const confirmed = window.Swal && typeof Swal.fire === 'function' 
        ? (await Swal.fire({ icon: 'question', title: 'Remove Item', text: 'Are you sure?', showCancelButton: true })).isConfirmed
        : confirm('Remove this item from cart?');

      if (!confirmed) return;

      try {
        await api(`/cart/${cartId}`, { method: 'DELETE' });
        await loadCart();
        if (typeof updateCartBadge === 'function') updateCartBadge();
      } catch (err) {
        const message = (err && err.message) ? err.message : JSON.stringify(err, null, 2);
        if (window.Swal && typeof Swal.fire === 'function') {
          Swal.fire({ icon: 'error', title: 'Remove Failed', text: message });
        }
      }
    }

    function updateSummary(total) {
      const totalFormatted = parseFloat(total).toFixed(2);
      document.getElementById('subtotal').textContent = `‚Ç±${totalFormatted}`;
      document.getElementById('total').textContent = `‚Ç±${totalFormatted}`;
      // Also update checkout totals if checkout box is visible
      const checkoutBox = document.getElementById('checkoutBox');
      if (checkoutBox && checkoutBox.classList.contains('show')) {
        document.getElementById('checkoutSubtotal').textContent = `‚Ç±${totalFormatted}`;
        document.getElementById('checkoutTotal').textContent = `‚Ç±${totalFormatted}`;
      }
    }

    // Function to setup numeric-only validation for contact number
    function setupContactNumberValidation() {
      const contactInputs = document.querySelectorAll('input[name="contact_number"], input#contactNumber');
      contactInputs.forEach(input => {
        input.addEventListener('keypress', function(e) {
          if ([46, 8, 9, 27, 13, 110, 190].indexOf(e.keyCode) !== -1 ||
              (e.keyCode === 65 && e.ctrlKey === true) ||
              (e.keyCode === 67 && e.ctrlKey === true) ||
              (e.keyCode === 86 && e.ctrlKey === true) ||
              (e.keyCode === 88 && e.ctrlKey === true) ||
              (e.keyCode >= 35 && e.keyCode <= 39)) {
            return;
          }
          if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
            e.preventDefault();
            if (window.Swal && typeof Swal.fire === 'function') {
              Swal.fire({ icon: 'warning', title: 'Numbers Only', text: 'Please enter only numbers for contact number.', timer: 2000, showConfirmButton: false });
            } else {
              alert('Please enter only numbers for contact number.');
            }
          }
        });
        input.addEventListener('input', function(e) {
          const value = this.value;
          const numericValue = value.replace(/[^0-9]/g, '');
          if (value !== numericValue) {
            this.value = numericValue;
            if (window.Swal && typeof Swal.fire === 'function') {
              Swal.fire({ icon: 'warning', title: 'Numbers Only', text: 'Only numbers are allowed. Letters have been removed.', timer: 2000, showConfirmButton: false });
            } else {
              alert('Only numbers are allowed. Letters have been removed.');
            }
          }
        });
      });
    }
    
    // Load user information to populate contact number
    async function loadUserInfo() {
      try {
        const user = await api('/users/me');
        const contactNumberInput = document.getElementById('contactNumber');
        if (contactNumberInput && user.contact_number) {
          contactNumberInput.value = user.contact_number;
        }
      } catch (err) {
        console.error('Failed to load user info:', err);
        // Silently fail - user can still enter contact number manually
      }
    }
    
    // Load saved address from current user's most recent order in database
    async function loadSavedAddress() {
      console.log('üîÑ loadSavedAddress() called (cart.html)');
      
      const shippingAddressInput = document.getElementById('shippingAddress');
      if (!shippingAddressInput) {
        console.log('‚ùå Shipping address textarea not found');
        // Retry after a short delay
        setTimeout(() => loadSavedAddress(), 200);
        return;
      }
      
      try {
        console.log('üì° Fetching user info...');
        // Get current user ID first
        const user = await api('/users/me');
        if (!user || !user.id) {
          console.log('‚ùå No user ID available');
          return;
        }
        const currentUserId = user.id;
        const userRole = user.role;
        const isSellerOrAdmin = userRole === 'seller' || userRole === 'admin';
        console.log('‚úÖ User ID:', currentUserId, 'Role:', userRole);
        
        // Skip address loading for admins and sellers - only load for regular users
        if (isSellerOrAdmin) {
          console.log('‚è≠Ô∏è Skipping address loading for admin/seller role');
          return;
        }
        
        // For regular users, backend will filter by user_id automatically
        console.log('üì° Fetching orders...');
        const ordersResponse = await api('/orders?sort_by=created_at&sort_order=desc');
        console.log('üì¶ Orders response:', ordersResponse);
        
        // Handle different response structures
        let orders = [];
        if (Array.isArray(ordersResponse)) {
          orders = ordersResponse;
        } else if (ordersResponse && ordersResponse.orders) {
          orders = ordersResponse.orders;
        } else if (ordersResponse && Array.isArray(ordersResponse.data)) {
          orders = ordersResponse.data;
        }
        
        console.log('üìã Parsed orders:', orders);
        console.log('üìä Total orders found:', orders.length);
        
        // Get the most recent order (already filtered by backend for regular users)
        if (orders && orders.length > 0) {
          const mostRecentOrder = orders[0];
          console.log('üì¶ Most recent order:', mostRecentOrder);
          const savedAddress = mostRecentOrder.shipping_address;
          console.log('üìç Address from order:', savedAddress);
          
          if (savedAddress && savedAddress.trim() !== '') {
            shippingAddressInput.value = savedAddress;
            console.log('‚úÖ Loaded address from most recent order for user', currentUserId, ':', savedAddress);
            // Trigger input event to ensure any listeners are notified
            shippingAddressInput.dispatchEvent(new Event('input', { bubbles: true }));
          } else {
            console.log('‚ö†Ô∏è Most recent order found but no shipping address');
          }
        } else {
          console.log('‚ÑπÔ∏è No previous orders found for current user', currentUserId);
        }
      } catch (err) {
        console.error('‚ùå Could not load address from orders:', err);
        // Silently fail - user can enter manually
      }
    }

    document.getElementById('checkoutBtn').addEventListener('click', async () => {
      const checkboxes = document.querySelectorAll('.cart-item-checkbox');
      const selectedItems = Array.from(checkboxes).filter(cb => cb.checked).map(cb => parseInt(cb.dataset.cartId));
      
      if (selectedItems.length === 0) {
        if (window.Swal && typeof Swal.fire === 'function') {
          Swal.fire({ icon: 'warning', title: 'No Items Selected', text: 'Please select at least one item to checkout' });
        } else {
          alert('Please select at least one item to checkout');
        }
        return;
      }
      
      // Show checkout box and scroll to it
      const checkoutBox = document.getElementById('checkoutBox');
      if (checkoutBox) {
        checkoutBox.classList.add('show');
        checkoutBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        // Update checkout totals based on selected items
        updateSelectedItems();
        // Setup contact number validation
        setupContactNumberValidation();
        
        // Load user info and address immediately
        await loadUserInfo();
        // Load saved address - wait a bit for DOM to be ready
        setTimeout(() => {
          loadSavedAddress();
        }, 100);
      }
    });

    // Handle checkout form submission
    document.getElementById('checkoutForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const checkboxes = document.querySelectorAll('.cart-item-checkbox');
      const selectedItems = Array.from(checkboxes).filter(cb => cb.checked).map(cb => parseInt(cb.dataset.cartId));
      
      if (selectedItems.length === 0) {
        if (window.Swal && typeof Swal.fire === 'function') {
          Swal.fire({ icon: 'warning', title: 'No Items Selected', text: 'Please select at least one item to checkout' });
        } else {
          alert('Please select at least one item to checkout');
        }
        return;
      }

      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData.entries());
      
      if (!data.shipping_address || !data.contact_number) {
        if (window.Swal && typeof Swal.fire === 'function') {
          Swal.fire({ icon: 'warning', title: 'Missing Information', text: 'Please fill in all required fields' });
        } else {
          alert('Please fill in all required fields');
        }
        return;
      }

      const total = parseFloat(document.getElementById('checkoutTotal').textContent.replace('‚Ç±', '').replace(',', '')) || 0;
      const confirmed = window.Swal && typeof Swal.fire === 'function' 
        ? (await Swal.fire({ 
            icon: 'question', 
            title: 'Place Order', 
            html: `Total: <strong>‚Ç±${total.toFixed(2)}</strong><br>Payment: Cash on Delivery<br><br>Confirm order?`,
            showCancelButton: true 
          })).isConfirmed
        : confirm(`Place order for ‚Ç±${total.toFixed(2)}?`);

      if (!confirmed) return;

      const placeOrderBtn = document.getElementById('placeOrderBtn');
      placeOrderBtn.disabled = true;
      placeOrderBtn.textContent = 'Placing Order...';

      try {
        // Prepare order items from selected items only
        console.log('=== CHECKOUT DEBUG ===');
        console.log('Selected checkbox IDs:', selectedItems);
        console.log('All cart items:', cartItems.map(i => ({ id: i.id, book_id: i.book_id, book_name: i.book?.name })));
        
        // Filter cart items to only include selected ones
        const selectedCartItems = cartItems.filter(item => {
          const itemId = parseInt(item.id);
          const isSelected = selectedItems.includes(itemId);
          console.log(`Cart item ${itemId}: selected=${isSelected}`);
          return isSelected;
        });
        
        console.log('Filtered selected items:', selectedCartItems.map(i => ({ id: i.id, book_id: i.book_id, book_name: i.book?.name })));
        
        if (selectedCartItems.length !== selectedItems.length) {
          console.error('ERROR: Mismatch between selected checkboxes and filtered items!', {
            selectedCheckboxCount: selectedItems.length,
            filteredItemsCount: selectedCartItems.length,
            selectedIds: selectedItems,
            cartItemIds: cartItems.map(i => parseInt(i.id))
          });
          if (window.Swal && typeof Swal.fire === 'function') {
            Swal.fire({ icon: 'error', title: 'Selection Error', text: 'There was an error processing selected items. Please try again.' });
          }
          return;
        }
        
        const orderItems = selectedCartItems.map(item => {
          const bookId = item.book_id || (item.book && item.book.id);
          if (!bookId) {
            console.error('Could not find book_id for item:', item);
            throw new Error(`Missing book_id for cart item ${item.id}`);
          }
          return {
            book_id: bookId,
            quantity: item.quantity,
            price: item.book ? parseFloat(item.book.price || 0) : (parseFloat(item.price || 0)),
            cart_item_id: parseInt(item.id) // Include cart item ID for backend to delete only selected items
          };
        });
        
        console.log('Order items being sent:', orderItems);
        console.log('=== END DEBUG ===');

        const orderData = {
          order_items: orderItems,
          shipping_address: data.shipping_address,
          contact_number: data.contact_number,
          payment_method: data.paymentMethod || 'cash_on_delivery',
          total_amount: total
        };

        const response = await api('/orders', {
          method: 'POST',
          data: orderData
        });

        if (window.Swal && typeof Swal.fire === 'function') {
          await Swal.fire({ 
            icon: 'success', 
            title: 'Order Placed!', 
            text: 'Your order has been placed successfully' 
          });
        }

        // Remove only selected items from cart
        for (const itemId of selectedItems) {
          try {
            await api(`/cart/${itemId}`, { method: 'DELETE' });
          } catch (err) {
            console.error('Failed to remove item from cart:', err);
          }
        }

        // Reload cart and hide checkout box
        await loadCart();
        const checkoutBox = document.getElementById('checkoutBox');
        if (checkoutBox) {
          checkoutBox.classList.remove('show');
        }
        document.getElementById('checkoutForm').reset();
        if (typeof updateCartBadge === 'function') updateCartBadge();

        // Redirect to orders page
        setTimeout(() => {
          location.href = 'orders.html';
        }, 1000);

      } catch (err) {
        const message = (err && err.message) ? err.message : JSON.stringify(err, null, 2);
        if (window.Swal && typeof Swal.fire === 'function') {
          Swal.fire({ icon: 'error', title: 'Order Failed', text: message });
        } else {
          alert('Failed to place order: ' + message);
        }
      } finally {
        placeOrderBtn.disabled = false;
        placeOrderBtn.textContent = 'Place Order';
      }
    });

    // Make functions globally accessible
    window.updateSelectedItems = updateSelectedItems;
    
    // Initialize
    // Initialize navigation and cart
    if (typeof requireAuth === 'function') {
      requireAuth().then(async () => {
        // Update navigation after authentication
        if (typeof setAuthUI === 'function') {
          setAuthUI(true);
        }
        // Check user role and redirect if seller/admin
        const canContinue = await checkUserRoleAndRedirect();
        if (!canContinue) return; // Stop if redirected
        
        // Get user role and update navigation
        if (typeof api === 'function') {
          api('/users/me').then(user => {
            if (typeof updateNavigationByRole === 'function') {
              updateNavigationByRole(user.role || 'user');
            }
          }).catch(() => {
            if (typeof updateNavigationByRole === 'function') {
              updateNavigationByRole('user');
            }
          });
        }
        loadCart();
        if (typeof updateCartBadge === 'function') updateCartBadge();
      });
    } else {
      // Check if user is logged in
      if (typeof isAuthed === 'function' && isAuthed()) {
        if (typeof setAuthUI === 'function') {
          setAuthUI(true);
        }
        // Check user role and redirect if seller/admin
        checkUserRoleAndRedirect().then(async (canContinue) => {
          if (!canContinue) return; // Stop if redirected
          
          if (typeof api === 'function') {
            api('/users/me').then(user => {
              if (typeof updateNavigationByRole === 'function') {
                updateNavigationByRole(user.role || 'user');
              }
            }).catch(() => {
              if (typeof updateNavigationByRole === 'function') {
                updateNavigationByRole('user');
              }
            });
          }
          loadCart();
          if (typeof updateCartBadge === 'function') updateCartBadge();
        });
      } else {
        if (typeof setAuthUI === 'function') {
          setAuthUI(false);
        }
        loadCart();
        if (typeof updateCartBadge === 'function') updateCartBadge();
      }
    }
  </script>
</body>
</html>

